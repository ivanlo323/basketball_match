<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>籃球比賽記錄</title>
    <style>
        table {
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            border: 1px solid black;
            padding: 5px;
            text-align: center;
        }
        .blue {
            background-color: lightblue;
        }
        .red {
            background-color: lightcoral;
        }
        .locked {
            pointer-events: none;
        }
        button.winButton {
            font-size: 1.1em;
            padding: 8px;
            margin: 5px;
        }
        button.winButton[data-team="blue"] {
            background-color: lightblue;
        }
        button.winButton[data-team="red"] {
            background-color: lightcoral;
        }
        #gameControls {
            margin-top: 20px;
        }
        button.aceButton {
            font-size: 0.9em;
            padding: 5px;
        }
        button.aceButton.active {
            background-color: lightgreen;
        }
        .total-column {
            background-color: lightgray;
        }
    </style>
</head>
<body>
    <h1>籃球比賽記錄</h1>
    
    <div id="playerSetup">
        人數: 
        <button id="minus">-</button>
        <span id="playerCount">6</span>
        <button id="plus">+</button>
        <button id="confirmPlayers">確定人數</button>
    </div>
    
    <div style="margin-bottom: 20px;">
        場錢: <input id="courtFee" type="number" value="0">
    </div>
    
    <table id="scoreTable">
        <thead>
            <tr>
                <th>Name</th>
                <th>王牌</th>
                <th class="total-column">總劃數</th>
                <th class="total-column">支付場錢</th>
            </tr>
        </thead>
        <tbody id="playerRows">
            <!-- 初始空白行 -->
        </tbody>
    </table>
    
    <div id="gameControls" style="display: none;">
        <button id="newGame">新一場</button>
        <button id="assignTeams" disabled>分隊</button>
        <button id="undo" disabled>還原</button>
        <button id="redo" disabled>取消還原</button>
        <button id="reset" style="background-color: lightgray; margin-left: 10px;">重置</button>
        <div>
            <button class="winButton" data-team="blue" data-multiplier="1" disabled>藍隊勝</button>
            <button class="winButton" data-team="blue" data-multiplier="2" disabled>藍隊勝(雙炒)</button>
            <button class="winButton" data-team="blue" data-multiplier="3" disabled>藍隊勝(三炒)</button>
            <button class="winButton" data-team="red" data-multiplier="1" disabled>紅隊勝</button>
            <button class="winButton" data-team="red" data-multiplier="2" disabled>紅隊勝(雙炒)</button>
            <button class="winButton" data-team="red" data-multiplier="3" disabled>紅隊勝(三炒)</button>
        </div>
    </div>

    <script>
        let playerCount = 6;
        let players = [];
        let games = [];
        let usedCombinations = new Set();
        let confirmed = false;
        let currentGame = -1;
        let totalFee = 0;
        let lastAction = null;
        let undoneAction = null;

        const playerCountSpan = document.getElementById('playerCount');
        const confirmPlayers = document.getElementById('confirmPlayers');
        const minus = document.getElementById('minus');
        const plus = document.getElementById('plus');
        const scoreTable = document.getElementById('scoreTable');
        const playerRows = document.getElementById('playerRows');
        const newGame = document.getElementById('newGame');
        const assignTeams = document.getElementById('assignTeams');
        const undoBtn = document.getElementById('undo');
        const redoBtn = document.getElementById('redo');
        const resetBtn = document.getElementById('reset');
        const gameControls = document.getElementById('gameControls');
        const courtFee = document.getElementById('courtFee');
        const winButtons = document.querySelectorAll('.winButton');

        // 初始鎖定減號
        minus.disabled = true;

        // 更新人數顯示並檢查按鈕狀態
        function updatePlayerCount() {
            playerCountSpan.textContent = playerCount;
            minus.disabled = playerCount <= 6;
            plus.disabled = playerCount >= 10;
        }

        // 加減人數
        minus.addEventListener('click', () => {
            if (playerCount > 6) {
                playerCount--;
                updatePlayerCount();
            }
        });

        plus.addEventListener('click', () => {
            if (playerCount < 10) {
                playerCount++;
                updatePlayerCount();
            }
        });

        // 載入狀態從 localStorage
        function loadState() {
            const savedState = localStorage.getItem('basketballRecordState');
            if (savedState) {
                const state = JSON.parse(savedState);
                playerCount = state.playerCount;
                confirmed = state.confirmed;
                currentGame = state.currentGame;
                totalFee = state.totalFee;
                usedCombinations = new Set(state.usedCombinations);
                games = state.games;
                lastAction = state.lastAction;
                undoneAction = state.undoneAction;

                // 重建 players (只存資料部分)
                state.playersData.forEach((pd, i) => {
                    const row = document.createElement('tr');
                    const nameCell = document.createElement('td');
                    nameCell.textContent = pd.name;
                    row.appendChild(nameCell);

                    const aceCell = document.createElement('td');
                    const aceButton = document.createElement('button');
                    aceButton.classList.add('aceButton');
                    aceButton.textContent = pd.aceGame ? `第${pd.aceGame}場` : '王牌';
                    aceButton.disabled = true;
                    aceCell.appendChild(aceButton);
                    row.appendChild(aceCell);

                    const totalScoreCell = document.createElement('td');
                    totalScoreCell.classList.add('total-column');
                    totalScoreCell.textContent = '0';
                    row.appendChild(totalScoreCell);

                    const payCell = document.createElement('td');
                    payCell.classList.add('total-column');
                    payCell.textContent = '0';
                    row.appendChild(payCell);

                    playerRows.appendChild(row);
                    players.push({
                        name: pd.name,
                        row,
                        aceButton,
                        totalScoreCell,
                        payCell,
                        total: 0,
                        aceUsed: pd.aceUsed,
                        aceGame: pd.aceGame
                    });
                });

                // 如果已確認，鎖定設定
                if (confirmed) {
                    document.getElementById('playerSetup').classList.add('locked');
                    minus.disabled = true;
                    plus.disabled = true;
                    confirmPlayers.disabled = true;
                    gameControls.style.display = 'block';
                    playerCountSpan.textContent = playerCount;
                    courtFee.value = totalFee;

                    // 重建表格欄位
                    const headRow = scoreTable.querySelector('thead tr');
                    games.forEach((g, idx) => {
                        const gameTh = document.createElement('th');
                        gameTh.textContent = `第${idx + 1}場`;
                        headRow.insertBefore(gameTh, headRow.children[headRow.children.length - 2]);
                    });

                    players.forEach(p => {
                        games.forEach(g => {
                            const gameTd = document.createElement('td');
                            gameTd.textContent = '0'; // 稍後更新
                            p.row.insertBefore(gameTd, p.totalScoreCell);
                        });
                    });

                    // 重建隊伍顏色、分數、王牌狀態、鎖定
                    games.forEach((g, gameIdx) => {
                        g.columnIndex = gameIdx + 2;
                        players.forEach((p, i) => {
                            const gameCell = p.row.children[g.columnIndex];
                            gameCell.textContent = g.scores[i];
                            const nameCell = p.row.children[0];
                            if (g.teams.blue.includes(i)) {
                                nameCell.classList.add('blue');
                                nameCell.classList.remove('red');
                                gameCell.classList.add('blue');
                                gameCell.classList.remove('red');
                            } else {
                                nameCell.classList.add('red');
                                nameCell.classList.remove('blue');
                                gameCell.classList.add('red');
                                gameCell.classList.remove('blue');
                            }
                            if (gameIdx < currentGame) {
                                gameCell.classList.add('locked');
                            }
                        });
                    });

                    // 更新王牌
                    players.forEach(p => {
                        if (p.aceUsed) {
                            p.aceButton.textContent = `第${p.aceGame}場`;
                            p.aceButton.disabled = true;
                        }
                    });

                    // 如果有當前遊戲，恢復狀態
                    if (currentGame >= 0) {
                        const current = games[currentGame];
                        const hasResult = current.scores.some(s => s > 0) || current.acesUsed.length > 0;
                        if (current.teams.blue.length > 0) {
                            assignTeams.disabled = true;
                            if (hasResult) {
                                winButtons.forEach(btn => btn.disabled = true);
                                players.forEach(p => p.aceButton.disabled = true);
                                newGame.disabled = false;
                                if (lastAction) undoBtn.disabled = false;
                            } else {
                                winButtons.forEach(btn => btn.disabled = false);
                                players.forEach((p, i) => {
                                    if (!p.aceUsed) {
                                        p.aceButton.disabled = false;
                                        p.aceButton.textContent = '王牌';
                                        p.aceButton.classList.remove('active');
                                        p.aceButton.onclick = () => {
                                            if (p.aceButton.textContent === '王牌') {
                                                p.aceButton.textContent = '使用';
                                                p.aceButton.classList.add('active');
                                            } else {
                                                p.aceButton.textContent = '王牌';
                                                p.aceButton.classList.remove('active');
                                            }
                                        };
                                    }
                                });
                                newGame.disabled = true;
                            }
                        } else {
                            assignTeams.disabled = false;
                            newGame.disabled = true;
                        }
                        if (undoneAction) redoBtn.disabled = false;
                    }

                    updateTotals();
                }
            } else {
                // 無儲存，初始狀態
                updatePlayerCount();
            }
        }

        // 儲存狀態到 localStorage
        function saveState() {
            const state = {
                playerCount,
                confirmed,
                currentGame,
                totalFee: parseFloat(courtFee.value) || 0,
                usedCombinations: Array.from(usedCombinations),
                games,
                lastAction,
                undoneAction,
                playersData: players.map(p => ({
                    name: p.name,
                    aceUsed: p.aceUsed,
                    aceGame: p.aceGame
                }))
            };
            localStorage.setItem('basketballRecordState', JSON.stringify(state));
        }

        // 頁面載入時呼叫
        loadState();

        // 確定人數
        confirmPlayers.addEventListener('click', () => {
            if (confirmed) return;
            confirmed = true;
            document.getElementById('playerSetup').classList.add('locked');
            minus.disabled = true;
            plus.disabled = true;
            confirmPlayers.disabled = true;
            gameControls.style.display = 'block';

            // 創建玩家行（如果未載入）
            if (players.length === 0) {
                playerRows.innerHTML = '';
                for (let i = 0; i < playerCount; i++) {
                    const row = document.createElement('tr');
                    const nameCell = document.createElement('td');
                    const nameInput = document.createElement('input');
                    nameInput.type = 'text';
                    nameCell.appendChild(nameInput);
                    row.appendChild(nameCell);

                    const aceCell = document.createElement('td');
                    const aceButton = document.createElement('button');
                    aceButton.classList.add('aceButton');
                    aceButton.textContent = '王牌';
                    aceButton.disabled = true;
                    aceCell.appendChild(aceButton);
                    row.appendChild(aceCell);

                    const totalScoreCell = document.createElement('td');
                    totalScoreCell.classList.add('total-column');
                    totalScoreCell.textContent = '0';
                    row.appendChild(totalScoreCell);

                    const payCell = document.createElement('td');
                    payCell.classList.add('total-column');
                    payCell.textContent = '0';
                    row.appendChild(payCell);

                    playerRows.appendChild(row);
                    players.push({
                        name: '',
                        row,
                        nameInput,
                        aceButton,
                        totalScoreCell,
                        payCell,
                        total: 0,
                        aceUsed: false,
                        aceGame: null
                    });
                }
            }

            players.forEach(p => p.nameInput.disabled = false);
            saveState();
        });

        // 新一場
        newGame.addEventListener('click', () => {
            if (newGame.disabled) return;
            currentGame++;
            if (currentGame === 0) {
                players.forEach((p, i) => {
                    p.name = p.nameInput.value.trim() || `玩家${i+1}`;
                    p.nameInput.parentNode.textContent = p.name;
                });
            }

            const headRow = scoreTable.querySelector('thead tr');
            const gameTh = document.createElement('th');
            gameTh.textContent = `第${currentGame + 1}場`;
            headRow.insertBefore(gameTh, headRow.children[headRow.children.length - 2]);

            players.forEach(p => {
                const gameTd = document.createElement('td');
                gameTd.textContent = '0';
                p.row.insertBefore(gameTd, p.totalScoreCell);
            });

            games.push({
                teams: {blue: [], red: []},
                scores: new Array(playerCount).fill(0),
                columnIndex: currentGame + 2,
                acesUsed: []
            });

            assignTeams.disabled = false;
            newGame.disabled = true;
            players.forEach(p => p.aceButton.disabled = true);
            undoBtn.disabled = true;
            redoBtn.disabled = true;
            lastAction = null;
            undoneAction = null;

            if (currentGame > 0) {
                const prevGame = games[currentGame - 1];
                players.forEach((p, i) => {
                    const prevCell = p.row.children[prevGame.columnIndex];
                    prevCell.classList.add('locked');
                });
            }

            updateTotals();
            saveState();
        });

        // 分隊
        assignTeams.addEventListener('click', () => {
            if (assignTeams.disabled) return;
            assignTeams.disabled = true;

            let combination;
            let attempts = 0;
            const maxAttempts = 10000;

            do {
                const indices = Array.from({length: playerCount}, (_, i) => i);
                indices.sort(() => Math.random() - 0.5);
                const half = Math.floor(playerCount / 2);
                let blue = indices.slice(0, half);
                let red = indices.slice(half);

                // 新增：標準化組合，不區分藍紅顏色
                const blueSorted = [...blue].sort((a, b) => a - b);
                const redSorted = [...red].sort((a, b) => a - b);
                let combArrays = blueSorted[0] < redSorted[0] ? [blueSorted, redSorted] : [redSorted, blueSorted];
                combination = JSON.stringify(combArrays);

                attempts++;
                if (attempts > maxAttempts) {
                    usedCombinations.clear();
                    attempts = 0;
                }
            } while (usedCombinations.has(combination));

            usedCombinations.add(combination);

            // 以下不變：解析回 blue 和 red，但現在 blue 總是「較小」的隊伍
            const parsedComb = JSON.parse(combination);
            let blueIndices = parsedComb[0];
            let redIndices = parsedComb[1];

            // 隨機決定顏色（因為現在 canonical 固定了順序，我們可以隨機互換顏色來保持視覺隨機性）
            if (Math.random() < 0.5) {
                [blueIndices, redIndices] = [redIndices, blueIndices];
            }

            const current = games[currentGame];
            current.teams.blue = blueIndices;
            current.teams.red = redIndices;

            players.forEach((p, i) => {
                const nameCell = p.row.children[0];
                const gameCell = p.row.children[current.columnIndex];
                if (blueIndices.includes(i)) {
                    nameCell.classList.add('blue');
                    nameCell.classList.remove('red');
                    gameCell.classList.add('blue');
                    gameCell.classList.remove('red');
                } else {
                    nameCell.classList.add('red');
                    nameCell.classList.remove('blue');
                    gameCell.classList.add('red');
                    gameCell.classList.remove('blue');
                }
                p.totalScoreCell.classList.remove('blue', 'red');
            });

            winButtons.forEach(btn => btn.disabled = false);
            players.forEach((p, i) => {
                if (!p.aceUsed) {
                    p.aceButton.disabled = false;
                    p.aceButton.textContent = '王牌';
                    p.aceButton.classList.remove('active');
                    p.aceButton.onclick = () => {
                        if (p.aceButton.textContent === '王牌') {
                            p.aceButton.textContent = '使用';
                            p.aceButton.classList.add('active');
                        } else {
                            p.aceButton.textContent = '王牌';
                            p.aceButton.classList.remove('active');
                        }
                    };
                }
            });
            saveState();
        });

        // 勝出按鈕
        winButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                if (btn.disabled) return;
                const winner = btn.dataset.team;
                const multiplier = parseInt(btn.dataset.multiplier);
                const current = games[currentGame];
                if (!current.teams.blue.length) return;

                const acesUsed = [];
                let aceCount = 0;
                players.forEach((p, i) => {
                    if (p.aceButton.textContent === '使用' && !p.aceUsed) {
                        const isWinner = (winner === 'blue' && current.teams.blue.includes(i)) ||
                                        (winner === 'red' && current.teams.red.includes(i));
                        if (isWinner) {
                            aceCount++;
                        }
                        acesUsed.push(i);
                        p.aceUsed = true;
                        p.aceGame = currentGame + 1;
                        p.aceButton.textContent = `第${p.aceGame}場`;
                        p.aceButton.classList.remove('active');
                        p.aceButton.disabled = true;
                    }
                });

                lastAction = {gameIndex: currentGame, winner, multiplier, acesUsed};
                undoneAction = null;
                redoBtn.disabled = true;

                const losers = winner === 'blue' ? current.teams.red : current.teams.blue;

                losers.forEach(i => {
                    current.scores[i] += multiplier * (1 + aceCount);
                    const cell = players[i].row.children[current.columnIndex];
                    cell.textContent = current.scores[i];
                });

                updateTotals();

                winButtons.forEach(b => b.disabled = true);
                players.forEach(p => p.aceButton.disabled = true);
                newGame.disabled = false;

                undoBtn.disabled = false;
                saveState();
            });
        });

        // 更新總計
        function updateTotals() {
            let grandTotal = 0;
            players.forEach((p, i) => {
                p.total = games.reduce((sum, g) => sum + g.scores[i], 0);
                p.totalScoreCell.textContent = p.total;
                grandTotal += p.total;
            });

            totalFee = parseFloat(courtFee.value) || 0;
            let totalPay = 0;
            if (grandTotal > 0 && totalFee > 0) {
                players.forEach(p => {
                    const pay = Math.ceil((p.total / grandTotal) * totalFee);
                    p.payCell.textContent = pay;
                    totalPay += pay;
                });
            } else {
                players.forEach(p => {
                    p.payCell.textContent = '0';
                });
            }

            updateTotalRowPosition(grandTotal, totalPay);
            saveState(); // 每次更新總計都儲存
        }

        function updateTotalRowPosition(grandTotal = 0, totalPay = 0) {
            let totalRow = playerRows.querySelector('.totalRow');
            if (!totalRow) {
                totalRow = document.createElement('tr');
                totalRow.classList.add('totalRow');
                playerRows.appendChild(totalRow);
            }

            totalRow.innerHTML = '';

            const labelTd = document.createElement('td');
            labelTd.textContent = '總數';
            totalRow.appendChild(labelTd);

            totalRow.appendChild(document.createElement('td'));

            for (let j = 0; j < games.length; j++) {
                totalRow.appendChild(document.createElement('td'));
            }

            const totalTd = document.createElement('td');
            totalTd.classList.add('total-column');
            totalTd.textContent = grandTotal;
            totalRow.appendChild(totalTd);

            const payTotalTd = document.createElement('td');
            payTotalTd.classList.add('total-column');
            payTotalTd.textContent = totalPay;
            totalRow.appendChild(payTotalTd);
        }

        // 場錢變化
        courtFee.addEventListener('input', updateTotals);

        // 還原
        undoBtn.addEventListener('click', () => {
            if (undoBtn.disabled || !lastAction || lastAction.gameIndex !== currentGame) return;
            const {gameIndex, winner, multiplier, acesUsed} = lastAction;
            const g = games[gameIndex];
            const losers = winner === 'blue' ? g.teams.red : g.teams.blue;

            let aceCount = 0;
            players.forEach((p, i) => {
                if (acesUsed.includes(i)) {
                    const isWinner = (winner === 'blue' && g.teams.blue.includes(i)) ||
                                    (winner === 'red' && g.teams.red.includes(i));
                    if (isWinner) {
                        aceCount++;
                    }
                    p.aceUsed = false;
                    p.aceGame = null;
                    p.aceButton.textContent = '王牌';
                    p.aceButton.classList.remove('active');
                    p.aceButton.disabled = false;
                }
            });
            losers.forEach(i => {
                g.scores[i] -= (multiplier * (1 + aceCount));
                const cell = players[i].row.children[g.columnIndex];
                cell.textContent = g.scores[i];
            });

            g.acesUsed = [];

            players.forEach(p => {
                if (!p.aceUsed) {
                    p.aceButton.disabled = false;
                    p.aceButton.onclick = () => {
                        if (p.aceButton.textContent === '王牌') {
                            p.aceButton.textContent = '使用';
                            p.aceButton.classList.add('active');
                        } else {
                            p.aceButton.textContent = '王牌';
                            p.aceButton.classList.remove('active');
                        }
                    };
                }
            });

            updateTotals();
            undoneAction = lastAction;
            lastAction = null;
            redoBtn.disabled = false;
            undoBtn.disabled = true;
            newGame.disabled = true;
            winButtons.forEach(b => b.disabled = false);
            saveState();
        });

        // 取消還原
        redoBtn.addEventListener('click', () => {
            if (redoBtn.disabled || !undoneAction) return;
            const {gameIndex, winner, multiplier, acesUsed} = undoneAction;
            const g = games[gameIndex];
            const losers = winner === 'blue' ? g.teams.red : g.teams.blue;

            let aceCount = 0;
            players.forEach((p, i) => {
                if (acesUsed.includes(i)) {
                    const isWinner = (winner === 'blue' && g.teams.blue.includes(i)) ||
                                    (winner === 'red' && g.teams.red.includes(i));
                    if (isWinner) {
                        aceCount++;
                    }
                    p.aceUsed = true;
                    p.aceGame = gameIndex + 1;
                    p.aceButton.textContent = `第${p.aceGame}場`;
                    p.aceButton.classList.remove('active');
                    p.aceButton.disabled = true;
                    g.acesUsed.push(i);
                }
            });
            losers.forEach(i => {
                g.scores[i] += (multiplier * (1 + aceCount));
                const cell = players[i].row.children[g.columnIndex];
                cell.textContent = g.scores[i];
            });

            players.forEach(p => p.aceButton.disabled = true);

            updateTotals();
            lastAction = undoneAction;
            undoneAction = null;
            redoBtn.disabled = true;
            undoBtn.disabled = false;
            newGame.disabled = false;
            winButtons.forEach(b => b.disabled = true);
            saveState();
        });

        // 重置按鈕
        resetBtn.addEventListener('click', () => {
            if (window.confirm("所有比賽記錄會被重置，確定嗎？")) {
                localStorage.removeItem('basketballRecordState');
                location.reload();
            }
        });
    </script>
</body>
</html>